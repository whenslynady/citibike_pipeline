name: CI-CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:

  # -------------------------------------------------------------
  # 1ï¸âƒ£ ANALIZ KÃ’D + PYTEST + DBT TESTS
  # -------------------------------------------------------------
  tests:
    name: Run Pytests + dbt Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: airflow
          POSTGRES_PASSWORD: airflow
          POSTGRES_DB: airflow
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U airflow"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install --no-cache-dir -r requirements.txt
          pip install apache-airflow pytest pytest-mock dbt-bigquery

      - name: ğŸ§ª Run pytests
        run: |
          export PYTHONPATH=$PYTHONPATH:$GITHUB_WORKSPACE/dags
          pytest tests/ -v

      - name: ğŸ§ª dbt workflow
        run: |
          cd dbt/citibike_dbt_gcp
          dbt debug --profiles-dir . --project-dir .
          dbt deps
          dbt compile
          dbt test

  # -------------------------------------------------------------
  # 2ï¸âƒ£ TERRAFORM VALIDATION
  # -------------------------------------------------------------
  terraform:
    name: Terraform Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ” Terraform Init
        working-directory: ./terraform
        run: terraform init -backend=false

      - name: ğŸ” Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: ğŸ§¹ Terraform Format Check
        working-directory: ./terraform
        run: terraform fmt -check

      - name: ğŸ“ Terraform Plan
        working-directory: ./terraform
        run: terraform plan

  # -------------------------------------------------------------
  # 3ï¸âƒ£ DEPLOY TO ASTRONOMER (SI OU VLE)
  # -------------------------------------------------------------
  deploy:
    name: Deploy to Astro
    needs: [tests, terraform]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Install Astro CLI
        run: curl -sSL install.astronomer.io | sudo bash

      - name: ğŸ” Login to Astro
        run: astro login ${{ secrets.ASTRO_API_URL }} --token ${{ secrets.ASTRO_TOKEN }}

      - name: ğŸš€ Deploy to Astro
        run: |
          astro deploy ${{ secrets.ASTRO_DEPLOYMENT_ID }} --force
